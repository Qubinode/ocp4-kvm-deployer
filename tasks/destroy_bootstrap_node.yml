---
- name: list all libvirt vms
  virt:
    command: list_vms
  register: all_vms
  tags: [ postinstall, bootstrap_shut ]

- name: shutdown bootstrap node
  tags: [ postinstall, bootstrap_shut ]
  vars:
    vm_name: "{{ bootstrap_node_name }}"
    vm_hostname: "{{ vm_name }}"
  block:
    - name: shutdown {{ bootstrap_node_name }}
      virt:
        name: "{{ vm_name }}"
        command: shutdown
      register: shutdown_vms
      when: bootstrap_node_name in all_vms.list_vms

    - name: include wait_for_vm_shutdown.yml
      include_tasks: wait_for_vm_shutdown.yml
      tags: [ postinstall, bootstrap_shut]
      when: bootstrap_node_name in all_vms.list_vms

    - name: destroy bootstrap node
      virt:
        name: "{{ vm_name }}"
        command: undefine
      tags: [ postinstall, bootstrap_shut ]
      when: bootstrap_node_name in all_vms.list_vms
