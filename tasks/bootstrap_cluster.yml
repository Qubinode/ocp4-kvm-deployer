---
- name:  BOOTSTRAPING THE CLUSTER - Declare empty list csrs_to_approve
  set_fact:
    csrs_to_approve: []
  tags: [ complete_install, bootstrap ]

- name: BOOTSTRAPING THE CLUSTER - Waiting on cluster {{ cluster_name }} bootstrap to complete
  shell: |
    openshift-install --dir "{{ openshift_install_dir }}"  wait-for bootstrap-complete --log-level debug 2>&1 | tee "{{ bootstrap_log }}" &
  register: bootstrap_wait_for_status
  until: "'Bootstrap status: complete' in bootstrap_wait_for_status.stdout"
  retries: 220
  delay: 30
  tags: [ bootstrap ]
  become: no
  changed_when: False

- name: BOOTSTRAPING THE CLUSTER - Check for pending CSRs
  shell: |
    oc get csr -ojson | jq -r '.items[] | select(.status == {} ) | .metadata.name'
  environment:
    KUBECONFIG: "{{ openshift_install_dir }}/auth/kubeconfig"
  become: no
  ignore_errors: yes
  register: pending_csrs
  changed_when: False
  tags: [ complete_install, bootstrap ]

- name: BOOTSTRAPING THE CLUSTER - Create a list of CSRs to approve
  set_fact:
    csrs_to_approve: "{{ pending_csrs.stdout_lines if pending_csrs.stdout_lines is defined else ''  }}"
  tags: [ complete_install, bootstrap ]

- name: BOOTSTRAPING THE CLUSTER - Approve pending CSRs
  when: csrs_to_approve | length > 0
  shell: |
    oc adm certificate approve {{ item }}
  environment:
    KUBECONFIG: "{{ openshift_install_dir }}/auth/kubeconfig"
  become: no
  ignore_errors: yes
  changed_when: False
  loop: "{{ csrs_to_approve }}"
  loop_control:
    label: "Approving csr {{ item }}"
  tags: [ complete_install, bootstrap ]

- name: BOOTSTRAPING THE CLUSTER - Verify the cluster bootstrapping is completed and all operators are up
  import_tasks: check_bootstrap.yml
  tags: [ bootstrap ]

- name: BOOTSTRAPING THE CLUSTER - Remove the boostrap RHCOS node
  import_tasks: destroy_bootstrap_node.yml
  tags: [ bootstrap ]

- name: Deploy /usr/local/bin/qubinode-ocp4-status
  template:
    src: templates/qubinode-ocp4-status.j2
    dest: /usr/local/bin/qubinode-ocp4-status
    group: "{{ local_user_account }}"
    owner: "{{ local_user_account }}"
    mode: u=rwx,g=rx,o=rx
  become: yes
  tags: [ complete_install, check_cluster_status, status_script, bootstrap ]

## These should be the next tasks
## - Image registry storage configuration
## - Configure OpenShift Internal register
